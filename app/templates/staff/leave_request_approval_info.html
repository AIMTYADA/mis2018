{% extends "base.html" %}
{% include "nav.html" %}
{% block page_content %}
<section class="section">
    <div class="container">
        {% for msg in get_flashed_messages() %}
        <p class="notification is-warning">{{ msg }}</p>
        {% endfor %}
        <h4 class="subtitle">รายการขออนุมัติลาของบุคลากรในสังกัดของ {{ current_user.personal_info }}</h4>
<table class="table is-bordered is-striped">
    <tbody>
        {% for approver in requesters %}
        {% if not approver.requester.leave_requests|sort(attribute='start_datetime')|checkallapprovals(approver.id) %}
        <tr>
            <td colspan="6">
                {{ approver.requester.personal_info.th_firstname }} {{ approver.requester.personal_info.th_lastname }}
            </td>
        </tr>
        {% for leave_req in approver.requester.leave_requests|sort(attribute='start_datetime') %}
        {% if not leave_req.cancelled_at %}
        {% if not leave_req|checkapprovals(approver.id) %}
        <tr>
            <td>
                {{ leave_req.created_at|localdatetime}}
            </td>
            <td>
                {{ leave_req.quota.leave_type}}
            </td>
            <td>
                เนื่องจาก: {{ leave_req.reason}}
            </td>
            <td>
                ในวันที่ {{ leave_req.start_datetime|localdatetime }} - {{ leave_req.end_datetime|localdatetime }}
            </td>
            <td>
                รวม {{ leave_req.duration }} วัน
            </td>
            <td>
                <a href="{{ url_for('staff.leave_approve', req_id=leave_req.id,approver_id=approver.id) }}" class="button is-info">อนุมัติ</a>

                <a href="{{ url_for('staff.leave_reject', req_id=leave_req.id,approver_id=approver.id) }}" class="button is-danger">ไม่อนุมัติ</a>
            </td>
        </tr>
        {% endif %}
        {% endif %}
        {% endfor %}
        {% endif %}
    {% endfor %}
    </tbody>
</table>
        <h4 class="subtitle">รายการยกเลิกการลาของบุคลากรในสังกัด</h4>
<table class="table is-bordered is-striped">
    <tbody>
        {% for approver in requesters %}
        {% if not approver.requester.leave_requests|checkallapprovals(approver.id) %}
        <tr>
            <td colspan="4">
                {{ approver.requester.personal_info.th_firstname }} {{ approver.requester.personal_info.th_lastname }}
            </td>
        </tr>
        {% for leave_req in approver.requester.leave_requests|sort(attribute='start_datetime',reverse=true) %}
        {% if leave_req.cancelled_at %}
        <tr>
            <td>
                ยกเลิกเมื่อ {{ leave_req.cancelled_at|localdatetime }}
            </td>
            <td>
                {{ leave_req.quota.leave_type}}
            </td>
            <td>
                {{ leave_req.start_datetime|localdatetime }} - {{ leave_req.end_datetime|localdatetime }}
            </td>
        </tr>
        {% endif %}
        {% endfor %}
        {% endif %}
    {% endfor %}
    </tbody>
</table>

<h4 class="subtitle">รายการการลาของบุคลากรในสังกัดที่ผ่านมา</h4>
<table class="table is-bordered is-striped">
    <tbody>
        {% for approver in requesters %}
        <tr>
            <td colspan="4">
                {{ approver.requester.personal_info.th_firstname }} {{ approver.requester.personal_info.th_lastname }}
            </td>
        </tr>
        {% for leave_req in approver.requester.leave_requests %}
        {% if not leave_req.cancelled_at %}
        <tr>
            <td>
                {{ leave_req.quota.leave_type}}
            </td>
            <td>
                {{ leave_req.start_datetime|localdatetime }} - {{ leave_req.end_datetime|localdatetime }}
            </td>
            <td>
                {{ leave_req.duration }}
            </td>
        </tr>
        {% endif %}
        {% endfor %}
        {% endfor %}
    </tbody>
</table>

    <a href="{{ url_for('staff.show_leave_info') }}" class="button is-rounded is-info is-light">
            <span class="icon">
                <i class="fas fa-arrow-left"></i>
            </span>
            กลับหน้าสรุปการลาของท่าน
    </a>
    </div>
</section>
{% endblock %}