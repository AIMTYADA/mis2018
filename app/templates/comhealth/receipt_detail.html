{% extends "base.html" %}
{% block page_content %}
    <section class="section hero is-info is-small">
        <div class="hero-head">
            <nav class="navbar">
                <div class="container">
                    <div class="navbar-brand">
                        <span class="navbar-burger burger" data-target="navbarMenuHeroA">
                            <span></span>
                            <span></span>
                            <span></span>
                          </span>
                    </div>
                    <div id="navbarMenuHeroA" class="navbar-menu">
                        <div class="navbar-end">
                            <a class="navbar-item is-active"
                                href="/comhealth">
                                <span class="icon">
                                    <i class="fas fa-home"></i>
                                </span>
                                <span>Home</span>
                            </a>
                            <a class="navbar-item"
                               href="/comhealth/tests">
                                <span>Tests</span>
                            </a>
                            <a class="navbar-item"
                               href="/comhealth/organizations">
                                <span>Organizations</span>
                            </a>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
        <div class="hero-body">
            <div class="container has-text-centered">
                <img src="{{ url_for('static', filename='img/medical-history.png') }}" width="100">
                <h1 class="title">Community Health Service Registration System</h1>
            </div>
        </div>
    </section>
    <section class="section" id="app">
        <div class="container" id="receipt">
            <div class="columns">
                <div class="column">
                    <p>เลขที่ 999 ถนนพุทธมณฑลสาย 4</p>
                    <p>ต.ศาลายา อ.พุทธมณฑล จ.นครปฐม 73170</p>
                    <p>เลขประจำตัวผู้เสียภาษี 4107039192</p>
                    <br>
                    <p>ชื่อ <strong>{{ receipt.record.customer.title or
                        '' }}{{ receipt.record.customer.firstname }} {{ receipt.record.customer.lastname }}</strong></p>
                </div>
                <div class="column has-text-centered">
                    <img width="80" src="{{ url_for('static', filename='img/logo-MU_black-white-2-1.png')}}">
                    <h4 class="title is-size-4">คณะเทคนิคการแพทย์ มหาวิทยาลัยมหิดล</h4>
                </div>
                <div class="column has-text-right">
                    <p>เลขที่ {{ receipt.id }}</p>
                    <p>วันที่ {{ receipt.created_datetime|localdate }}</p>
                </div>
            </div>
            <hr>
            <div class="columns">
                {% if visible_profile_tests %}
                <div class="column">
                    <p><strong>รายการทดสอบ</strong></p>
                    <table class="table is-narrow">
                        <thead>
                        </thead>
                        <tbody>
                            {% for t in visible_profile_tests %}
                            {% if t.test_item.profile %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ t.test_item.test.name }}</td>
                                {% if t.billed %}
                                <td>{{ t.price or t.test_item.test.default_price }}</td>
                                {% else %}
                                <td>0.0</td>
                                {% endif %}
                                <td>บาท</td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                            <tr>
                                <td></td>
                                <td><strong>รวม</strong></td><td>{{ total_profile_cost }}</td>
                                {% if receipt.paid %}
                                <td>PAID</td>
                                {% else %}
                                {% endif %}
                                <td>บาท</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                {% endif %}
                <div class="column">
                    <p><strong>รายการทดสอบเพิ่มเติม</strong></p>
                    <table class="table is-narrow">
                        <thead>
                        <th>ลำดับ</th>
                        <th>รายการทดสอบ</th>
                        <th>รหัสกรมบัญชีกลาง</th>
                        <th>ราคา</th>
                        <th>เบิกได้ (บาท)</th>
                        <th>เบิกไม่ได้ตามระเบียบกระทรวงการคลัง (บาท)</th>
                        </thead>
                        <tbody>
                            {% for t in visible_special_tests %}
                            {% if t.test_item.group %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ t.test_item.test.desc }} ({{ t.test_item.test.name }})</td>
                                <td>{{ t.test_item.test.gov_code }}</td>
                                {% if t.billed %}
                                    {% if t.test_item.price %}
                                    <td>{{ t.test_item.price }}</td>
                                    <td>{{ t.test_item.test.default_price }}</td>
                                    <td>{{ t.test_item.price - t.test_item.test.default_price }}</td>
                                    {% endif %}
                                {% else %}
                                <td>0.0</td>
                                {% endif %}
                            </tr>
                            {% endif %}
                            {% endfor %}
                            <tr>
                                <td></td>
                                <td></td>
                                <td><strong>รวม</strong></td><td>{{ total_special_cost }}</td>
                                <td></td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="columns">
                <div class="column">
                    <hr>
                    <table class="table">
                        <tr>
                            <td>
                                <strong>รวมเงิน (ตัวอักษร) {{ total_special_cost_thai }} บาท</strong>
                            </td>
                            <td>
                                <strong>รวมทั้งสิ้น {{ total_cost }} บาท</strong>
                            </td>
                        </tr>
                        {% if receipt.paid %}
                        <tr>
                            <td>
                                {% if receipt.payment_method == 'cash' %}
                                ชำระด้วยเงินสด
                                {% elif receipt.payment_method == 'card' %}
                                ชำระด้วยบัตรเครดิต หมายเลข {{ receipt.card_number }}
                                {% else %}
                                ยังไม่ได้ชำระเงิน
                                {% endif %}
                            </td>
                            <td></td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="columns">
                {%if not receipt.paid %}
                <div class="box">
                   <form method="post" action="/comhealth/checkin/receipts/pay/{{receipt.id}}">
                       <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                       <div class="control">
                           <label class="radio">
                               <input type="radio" checked name="pay_method" value="cash">
                               เงินสด
                           </label>
                           <label class="radio">
                               <input type="radio" name="pay_method" value="card">
                               บัตรเครดิต
                           </label>
                       </div>
                       <div class="control">
                           <input type="text" placeholder="Card Number"
                                  class="input" maxlength="16" name="card_number">
                       </div>
                       <br>
                       <div class="control">
                           <button class="button is-rounded is-success" type="submit"
                                   {% if receipt.cancelled %}disabled{% endif %}>
                               ชำระเงิน</button>
                       </div>
                   </form>
                </div>
                {% endif %}
            </div>
            <div class="columns">
                <div class="column">
                    <button class="button is-info is-rounded"
                                @click="printJS('{{url_for('comhealth.export_receipt_pdf', receipt_id=receipt.id)}}')"
                        {% if receipt.cancelled or not receipt.paid %}disabled{% endif %}
                                >
                        <span class="icon">
                            <i class="fas fa-print"></i>
                        </span>
                        <span>พิมพ์ใบเสร็จ</span>
                    </button>
                    <a class="button is-danger is-rounded"
                        href="{{ url_for('comhealth.cancel_receipt',
                                receipt_id=receipt.id) }}"
                        {% if receipt.cancelled %}disabled{% endif %}
                                >ยกเลิก</a>
                    <a class="button is-primary is-rounded" href="{{
                                                        url_for('comhealth.list_all_receipts',
                                                        record_id=receipt.record.id)
                                                        }}">กลับ</a>
                </div>
            </div>
        </div>
    </section>
{% endblock %}
{% block scripts %}
    {{ super() }}
    <script type="text/javascript">
        var vm = new Vue({
            el: "#app",
            delimiters: ['<%', '%>'],
            data() {
                return {
                }
            },
            computed: {}
        });
    </script>
{% endblock %}
