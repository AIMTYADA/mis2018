{% extends "base.html" %}
{% include "PA/nav.html" %}
{% block page_content %}
    <section class="section">
        <div class="container">
        {% include "messages.html" %}
            <div class="columns">
                <div class="column">
                    <h1 class="title has-text-centered">คำขอ {{ req.for_ }} PA</h1>
                </div>
            </div>
            <div class="columns">
                <div class="column is-half is-offset-3">
                    <div class="box">
                        <div class="field">
                            <span>ผู้รับการประเมิน:</span>
                            <p class="title is-size-4">{{ req.pa.staff.personal_info.fullname }}</p>
                        </div>
                        <div class="field">
                            <span>รอบการประเมิน:</span>
                            <label class="label">{{ req.pa.round }}</label>
                        </div>
                        <div class="field">
                             ประเภทคำขอ: <p class="title is-size-4">{{ req.for_ }}</p>
                        </div>
                        {% if req.detail %}
                            <div class="field">
                                รายละเอียด
                                <label class="label">
                                    {{ req.detail}}
                                </label>
                            </div>
                            </div>
                        {% endif %}
                        {% if req.responded_at %}
                            <div class="field">
                                <span>ผู้บังคับบัญชาขั้นต้น
                                    <label class="label">"{{ req.status }}" เมื่อ
                                        {{ req.responded_at|localdatetime }}
                                    </label>
                                </span>
                                <label class="label">
                                    comment: {{ req.supervisor_comment }}
                                </label>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="columns">
                <div class="column">
                    <table class="table is-fullwidth is-bordered">
                        <thead>
                        <th>หมวด</th>
                        <th>ภาระงาน</th>
                        </thead>
                        <tbody>
                        {% for cat in categories %}
                            <tr>
                                <td style="width: 15%">
                                    {{ cat }}
                                </td>
                                <td>
                                    {% if cat.pa_items.filter_by(pa_id=req.pa.id).all() %}
                                        <table class="table is-fullwidth">
                                            <thead>
                                            <th>ภาระงาน</th>
                                            <th>ร้อยละ(น้ำหนัก)</th>
                                            <th>ตัวชี้วัด (หากมีหลายตัวชี้วัดคะแนนจะถูกนำมาเฉลี่ย)</th>
                                            </thead>
                                            <tbody>
                                            {% for pa_item in cat.pa_items.filter_by(pa_id=req.pa.id) %}
                                                <tr {% if pa_item_id == pa_item.id %}
                                                    style="background-color: palegreen" {% endif %}>
                                                    <td style="width: 40%">{{ pa_item.task }}</td>
                                                    <td style="width: 5%">{{ pa_item.percentage }}</td>
                                                    <td>
                                                        <ul>
                                                            {% for kpi_item in pa_item.kpi_items %}
                                                                <li>{{ kpi_item }}</li>
                                                            {% endfor %}
                                                        </ul>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    {% if not req.responded_at %}
                    <form method="post" action="{{ url_for('pa.respond_request', request_id=req.id) }}">
                        <input type="hidden" value="{{ csrf_token() }}" name="csrf_token">
                        <div class="field">
                            <div class="control">
                                <label class="label">
                                    <input type="radio" name="approval" value="ไม่อนุมัติ">
                                    ไม่อนุมัติ
                                </label>
                            </div>
                            <div class="control">
                                <label class="label">
                                    <input type="radio" checked name="approval" value="อนุมัติ">
                                    อนุมัติ
                                </label>
                            </div>
                        </div>
                        <div class="field">
                            <label class="label">Comment</label>
                            <div class="control">
                                <textarea name="supervisor_comment" class="textarea"></textarea>
                            </div>
                        </div>
                        <div class="field is-grouped is-grouped-centered">
                            <div class="control">
                                <a href="{{ url_for('pa.all_request') }}"
                                   class="button is-light">Back</a>
                            </div>
                            <div class="control">
                                <input type="submit" value="Submit" class="button is-success"/>
                            </div>
                        </div>
                    </form>
                    {% else %}
                        <div class="field is-grouped is-grouped-centered">
                            <div class="control">
                                <a href="{{ url_for('pa.all_request') }}"
                                   class="button is-light">กลับ</a>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>
{% endblock %}