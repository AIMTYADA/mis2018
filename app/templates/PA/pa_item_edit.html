{% extends "base.html" %}
{% block head %}
    {{ super() }}
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
{% endblock %}
{% block title %}MUMT MIS: Performance Agreement {% endblock %}
{% include "PA/nav.html" %}
{% block page_content %}
    <section class="section">
        <div class="container">
            {% include 'messages.html' %}
            <div class="columns">
                <div class="column">
                    {% if task_id %}
                        <h1 class="title has-text-centered">แก้ไขภาระงาน้</h1>
                        <h1 class="subtitle has-text-centered">รอบการประเมิน {{ pa_round }}</h1>
                    {% else %}
                        <h1 class="title has-text-centered">เพิ่มภาระงาน</h1>
                        <h1 class="subtitle has-text-centered">รอบการประเมิน {{ pa_round }}</h1>
                        <p>
                        <span class="icon"><i class="fa-solid fa-clock-rotate-left"></i></span>{{ pa.updated_at|localdatetime }}
                        </p>
                    {% endif %}
                    <form method="post">
                        {{ form.hidden_tag() }}
                        <br>
                        <div class="card">
                            <div class="card-header">
                                <p class="card-header-title">ส่วนที่ 2 ข้อตกลงการปฏิบัติงาน(Performance Agreement:
                                    PA)</p>
                            </div>
                            <div class="card-content">
                                <p class="subtitle is-6">
                                    1.ให้ผู้บังคับบัญชาชั้นต้นและผู้รับการประเมินตกลงร่วมกันเกี่ยวกับภาระงาน ค่าน้ำหนัก
                                    ตัวชี้วัด เป้าหมาย เกณฑ์การประเมิน ให้สอดคล้องตามลักษณะงาน ตำแหน่งงานและความรู้
                                    ความสามารถ โดยให้คำนึงถึงแผนยุทธศาสตร์ แผนกลยุทย์ และหรือเป้าหมายของมหาวิทยาลัย
                                    ส่วนงานและหรือหน่วยงาน</p>
                                <p class="subtitle is-6">2.ให้ผู้รับการประเมินกรอกภาระงาน ค่าน้ำหนัก ตัวชี้วัด เป้าหมาย
                                    เกณฑ์การประเมิน เป็นลายลักษณ์อักษร
                                    พร้อมให้ผู้รับการประเมินและผู้บังคับบัญชาชั้นต้นลงลายมือชื่อไว้ด้วย</p>
                                <p class="subtitle is-6">2.1 ภาระงานและตัวชี้วัดเป้าหมายความสำเร็จของภาระงาน</p>
                                <table class="table is-fullwidth is-bordered">
                                    <thead>
                                    <th>หมวด</th>
                                    <th>ภาระงาน</th>
                                    </thead>
                                    <tbody>
                                    {% for cat in categories %}
                                        <tr>
                                            <td style="width: 10%">
                                                {{ cat }}
                                            </td>
                                            <td>
                                                {% if cat.pa_items.filter_by(pa_id=pa.id).all() %}
                                                    <table class="table is-fullwidth">
                                                        <thead>
                                                        <th>งานที่รับผิดชอบ</th>
                                                        <th>%</th>
                                                        <th>ผลการดำเนินการ</th>
                                                        <th>ตัวชี้วัด</th>
                                                        <th></th>
                                                        </thead>
                                                        <tbody>
                                                        {% for pa_item in cat.pa_items.filter_by(pa_id=pa.id) %}
                                                            <tr {% if pa_item_id == pa_item.id %}
                                                                style="background-color: palegreen" {% endif %}>
                                                                <td style="width: 20%">{{ pa_item.task|safe }}</td>
                                                                <td style="width: 10%">{{ pa_item.percentage }}</td>
                                                                <td style="width: 30%;">{{ pa_item.report|safe }}</td>
                                                                <td style="width: 30%">
                                                                    <ul>
                                                                        {% for kpi_item in pa_item.kpi_items %}
                                                                            <li><span class="icon"><i class="fa-solid fa-star has-text-warning"></i></span><small>{{ kpi_item }}</small></li>
                                                                        {% endfor %}
                                                                    </ul>
                                                                </td>
                                                                <td>
                                                                    <div class="buttons">
                                                                        <a href="{{ url_for('pa.add_pa_item', round_id=pa_round.id, item_id=pa_item.id, pa_id=pa.id, _anchor='edit_form') }}"
                                                                           class="button is-rounded">
                                                                            <span class="icon">
                                                                                <i class="fa-solid fa-pencil {% if pa_item_id == pa_item.id %} has-text-success {% endif %}"></i>
                                                                            </span>
                                                                        </a>
                                                                        {% if pa.approved_at == None %}
                                                                        <a class="button is-rounded">
                                                                            <span class="icon">
                                                                                <i class="fa-solid fa-trash-can has-text-danger"></i>
                                                                            </span>
                                                                        </a>
                                                                        {% endif %}
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                        </tbody>
                                                    </table>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                                <div>
                                    <a id="edit_form"></a>
                                    <p class="title is-size-4 has-text-centered">
                                        เพิ่ม/แก้ไขข้อมูลภาระงานและตัวชี้วัด
                                    </p>
                                    <div class="field">
                                        <label class="label">
                                            {% if pa.approved_at %}
                                                <span class="icon"><i class="fa-solid fa-lock"></i></span>
                                            {% endif %}
                                            {{ form.category.label }}
                                        </label>
                                        <div class="select {% if pa_item_id %}is-success{% endif %}">
                                            {{ form.category(disabled=pa.approved_at != None) }}
                                        </div>
                                    </div>
                                    <div class="field">
                                        <label class="label">
                                            {% if pa.approved_at %}
                                                <span class="icon"><i class="fa-solid fa-lock"></i></span>
                                            {% endif %}
                                            {{ form.task.label }}
                                        </label>
                                        <div class="control">
                                            {{ form.task(required=True, class="textarea is-success" if pa_item_id else "textarea", disabled=pa.approved_at != None) }}
                                        </div>
                                    </div>
                                    {% if pa_item_id and pa.approved_at %}
                                    <div class="field">
                                        <label class="label">
                                            <span class="icon">
                                                <i class="fa-solid fa-lock-open"></i>
                                            </span>
                                            {{ form.report.label }}
                                        </label>
                                        <div class="control">
                                            {{ form.report(class="textarea is-success" if pa_item_id else "textarea") }}
                                        </div>
                                    </div>
                                    {% endif %}
                                    <div class="field">
                                        <label class="label">
                                            {% if pa.approved_at %}
                                                <span class="icon"><i class="fa-solid fa-lock"></i></span>
                                            {% endif %}
                                            ร้อยละ(น้ำหนัก)
                                        </label>
                                        <div class="control">
                                            {{ form.percentage(class="input is-success" if pa_item_id else "input", required=True, disabled=pa.approved_at != None) }}
                                        </div>
                                    </div>
                                    <div class="field">
                                        <label class="label">
                                            {% if pa.approved_at %}
                                                <span class="icon"><i class="fa-solid fa-lock"></i></span>
                                            {% endif %}
                                            ตัวชี้วัดเป้าหมายความสำเร็จของภาระงาน
                                        </label>
                                        <p class="help is-danger">สามารถระบุได้มากกว่า 1 ตัวชี้วัด
                                            โดยคะแนนจะมาจากค่าเฉลี่ยของทุกตัว</p>
                                    </div>
                                    {% if pa.kpis %}
                                        <table class="table is-fullwidth is-striped">
                                        {% for item_form in form.kpi_items_ %}
                                            <tr>
                                                <td>
                                                    <div class="field">
                                                        <label class="label">
                                                            {{ loop.index }}) {{ item_form.label }}
                                                        </label>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="select">
                                                        {{ item_form(disabled=pa.approved_at != None) }}
                                                    </div>
                                                    {% if pa.approved_at %}
                                                        <input name="{{ item_form.id }}" value="{{ item_form.data or '' }}" type="hidden">
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                        </table>
                                        <div class="field">
                                            {% if pa.approved_at == None %}
                                            <a class="button is-info"
                                               href="{{ url_for('pa.add_kpi', pa_id=pa.id, round_id=pa_round.id) }}">
                                                <span class="icon">
                                                    <i class="fa-solid fa-location-crosshairs"></i>
                                                </span>
                                                <span>เพิ่มตัวชี้วัด</span>
                                            </a>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <div class="field">
                                            <a class="button is-info"
                                                    href="{{ url_for('pa.add_kpi', pa_id=pa.id, round_id=pa_round.id) }}">
                                                <span class="icon">
                                                    <i class="fa-solid fa-location-crosshairs"></i>
                                                </span>
                                                <span>เพิ่มตัวชี้วัด</span>
                                            </a>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="field is-grouped is-grouped-centered">
                                    <div class="control">
                                        <input type="submit" value="บันทึกภาระงาน" class="button is-success">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                    <div class="buttons is-centered">
                        <a href="{{ url_for('pa.create_request', pa_id=pa.id) }}"
                           class="button is-info is-outlined">
                            <span class="icon">
                                <i class="fa-sharp fa-solid fa-paper-plane"></i>
                            </span>
                            <span>ส่งคำขอ</span>
                        </a>
                        <a href="{{ url_for('pa.create_scoresheet_for_self_evaluation', pa_id=pa.id) }}"
                           class="button is-warning is-outlined">
                            <span class="icon">
                                <i class="fa-solid fa-star"></i>
                            </span>
                            <span>ประเมินภาระงานตนเอง</span>
                        </a>
                        <a href="{{ url_for('pa.rate_core_competency', pa_id=pa.id, for_self='true', next_url=request.url) }}"
                           class="button is-warning is-outlined">
                            <span class="icon">
                                <i class="fa-solid fa-star"></i>
                            </span>
                            <span>ประเมินสมรรถนะหลัก</span>
                        </a>
                    </div>
                </div>
            </div>
            <div class="columns">
                <div class="column">
                    <h1 class="title">สถานะการประเมินภาระงาน</h1>
                    <table class="table">
                        <thead>
                        <th>สร้างเมื่อ</th>
                        <th>เพื่อ</th>
                        <th>รายละเอียด</th>
                        <th>สถานะ</th>
                        <th>ส่งเมื่อ</th>
                        <th>ตอบกลับเมื่อ</th>
                        <th>comment</th>
                        <th>หัวหน้าส่วนงาน</th>
                        </thead>
                        <tbody>
                        {% for req in pa.requests %}
                            <tr>
                                <td>{{ req.created_at|localdatetime }}</td>
                                <td>{{ req.for_ }}</td>
                                <td>{{ req.detail }}</td>
                                <td>{{ req.status or 'ระหว่างดำเนินการ' }}</td>
                                <td>{{ req.submitted_at|localdatetime }}</td>
                                <td>{{ req.responded_at or '' }}</td>
                                <td>{{ req.supervisor_comment }}</td>
                                <td>{{ req.supervisor.fullname }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>
{% endblock %}
{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
<script>
    let toolbar = [
        // [groupName, [list of button]]
        ['table', ['table']],
        ['font', ['bold', 'underline', 'strikethrough', 'superscript', 'subscript']],
        ['fontsize', ['fontsize']],
        ['para', ['ul', 'ol', 'paragraph']],
        ['height', ['height']]
    ]
    let options = {
        height: 400,
        toolbar: toolbar
    }
    $(document).ready(function() {
        $('#report').summernote(options);
        $('#task').summernote(options);
    })

</script>
{% endblock %}