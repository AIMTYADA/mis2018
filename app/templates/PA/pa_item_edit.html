{% extends "base.html" %}
{% block title %}MUMT MIS: Performance Agreement {% endblock %}
{% include "PA/nav.html" %}
{% block head %}
{{ super() }}
<style>
#myBtn {
  display: none; /* Hidden by default */
  position: fixed; /* Fixed/sticky position */
  bottom: 20px; /* Place the button at the bottom of the page */
  right: 30px; /* Place the button 30px from the right */
  z-index: 99; /* Make sure it does not overlap */
  border: none; /* Remove borders */
  outline: none; /* Remove outline */
  background-color: red; /* Set a background color */
  color: white; /* Text color */
  cursor: pointer; /* Add a mouse pointer on hover */
  padding: 15px; /* Some padding */
  border-radius: 10px; /* Rounded corners */
  font-size: 18px; /* Increase font size */
}

#myBtn:hover {
  background-color: #555; /* Add a dark-grey background on hover */
}
</style>
{% endblock %}
{% block page_content %}
    <section class="section">
        <div>
            {% include 'messages.html' %}
            <div class="columns">
                <div class="column">
                    {% if task_id %}
                        <h1 class="title has-text-centered">แก้ไขภาระงาน</h1>
                        <h1 class="subtitle has-text-centered">รอบการประเมิน {{ pa_round }}</h1>
                    {% else %}
                        <h1 class="title has-text-centered">เพิ่มภาระงาน</h1>
                        <h1 class="subtitle has-text-centered">รอบการประเมิน {{ pa_round }}</h1>
                        <p>
                        <span class="icon"><i class="fa-solid fa-clock-rotate-left"></i></span>{{ pa.updated_at|localdatetime }}
                        </p>
                    {% endif %}
                    <form method="post">
                        {{ form.hidden_tag() }}
                        <br>
                        <div class="card">
                            <div class="card-header">
                                <p class="card-header-title">ส่วนที่ 2 ข้อตกลงการปฏิบัติงาน(Performance Agreement:
                                    PA)</p>
                            </div>
                            <div class="card-content">
                                <p class="subtitle is-6">
                                    1.ให้ผู้บังคับบัญชาชั้นต้นและผู้รับการประเมินตกลงร่วมกันเกี่ยวกับภาระงาน ค่าน้ำหนัก
                                    ตัวชี้วัด เป้าหมาย เกณฑ์การประเมิน ให้สอดคล้องตามลักษณะงาน ตำแหน่งงานและความรู้
                                    ความสามารถ โดยให้คำนึงถึงแผนยุทธศาสตร์ แผนกลยุทย์ และหรือเป้าหมายของมหาวิทยาลัย
                                    ส่วนงานและหรือหน่วยงาน</p>
                                <p class="subtitle is-6">2.ให้ผู้รับการประเมินกรอกภาระงาน ค่าน้ำหนัก ตัวชี้วัด เป้าหมาย
                                    เกณฑ์การประเมิน เป็นลายลักษณ์อักษร
                                    พร้อมให้ผู้รับการประเมินและผู้บังคับบัญชาชั้นต้นลงลายมือชื่อไว้ด้วย</p>
                                <p class="subtitle is-6">2.1 ภาระงานและตัวชี้วัดเป้าหมายความสำเร็จของภาระงาน</p>
                                <table class="table is-fullwidth is-bordered">
                                    <thead>
                                    <th>หมวด</th>
                                    <th>ภาระงาน</th>
                                    </thead>
                                    <tbody>
                                    {% for cat in categories %}
                                        <tr>
                                            <td style="width: 10%">
                                                {{ cat }}
                                            </td>
                                            <td>
                                                {% if cat.pa_items.filter_by(pa_id=pa.id).all() %}
                                                    <table class="table is-fullwidth">
                                                        <thead>
                                                        <th>งานที่รับผิดชอบ</th>
                                                        <th>%</th>
                                                        <th>ผลการดำเนินการ</th>
                                                        <th>ตัวชี้วัด</th>
                                                        <th></th>
                                                        </thead>
                                                        <tbody>
                                                        {% for pa_item in cat.pa_items.filter_by(pa_id=pa.id) %}
                                                            <tr {% if pa_item_id == pa_item.id %}
                                                                style="background-color: palegreen" {% endif %}>
                                                                <td style="width: 20%">{{ pa_item.task|safe }}</td>
                                                                <td style="width: 10%">{{ pa_item.percentage }}</td>
                                                                <td style="width: 30%;">{{ pa_item.report|safe }}</td>
                                                                <td style="width: 30%">
                                                                    <ul>
                                                                        {% for kpi_item in pa_item.kpi_items %}
                                                                            <li><span class="icon"><i class="fa-solid fa-star has-text-warning"></i></span><small>{{ kpi_item }}</small></li>
                                                                        {% endfor %}
                                                                    </ul>
                                                                </td>
                                                                <td>
                                                                    <div class="buttons">
                                                                        {% if pa.editable %}
                                                                        <a href="{{ url_for('pa.add_pa_item', round_id=pa_round.id, item_id=pa_item.id, pa_id=pa.id, _anchor='edit_form') }}"
                                                                           class="button">
                                                                            <span class="icon is-small">
                                                                                <i class="fa-solid fa-pencil {% if pa_item_id == pa_item.id %} has-text-success {% endif %}"></i>
                                                                            </span>
                                                                        </a>
                                                                        <a class="button" hx-swap="none" hx-confirm="คุณต้องการลบรายการนี้หรือไม่"
                                                                           hx-delete="{{ url_for('pa.delete_pa_item', pa_id=pa.id, pa_item_id=pa_item.id) }}">
                                                                            <span class="icon is-small">
                                                                                <i class="fa-solid fa-trash-can has-text-danger"></i>
                                                                            </span>
                                                                        </a>
                                                                        {% endif %}
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                        </tbody>
                                                    </table>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    <tr>
                                        <td>รวม</td>
                                        <td><strong>{{ pa.total_percentage }}</strong></td>
                                    </tr>
                                    </tbody>
                                </table>
                                <a id="edit_form"></a>
                                <p class="title is-size-4 has-text-centered">
                                    เพิ่ม/แก้ไขข้อมูลภาระงานและตัวชี้วัด
                                </p>
                                <div class="field">
                                    <label class="label">
                                        {% if pa.approved_at or pa.submitted %}
                                            <span class="icon"><i class="fa-solid fa-lock"></i></span>
                                        {% endif %}
                                        {{ form.category.label }}
                                    </label>
                                    <div class="select {% if pa_item_id %}is-success{% endif %}">
                                        {% if pa.approved_at or pa.submitted %}
                                            {{ form.category(disabled=True) }}
                                        {% elif not pa.approved_at %}
                                            {{ form.category() }}
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="label">
                                        {% if pa.approved_at or pa.submitted %}
                                            <span class="icon"><i class="fa-solid fa-lock"></i></span>
                                        {% endif %}
                                        {{ form.task.label }}
                                    </label>
                                    <div class="control">
                                        {% if pa.approved_at or pa.submitted %}
                                            {{ form.task(required=True, class="textarea is-success" if pa_item_id else "textarea", disabled=True) }}
                                        {% elif not pa.approved_at %}
                                            {{ form.task(required=True, class="textarea is-success" if pa_item_id else "textarea") }}
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="label">
                                        {% if not pa.editable %}
                                            <span class="icon"><i class="fa-solid fa-lock"></i></span>
                                        {% endif %}
                                        ร้อยละ(น้ำหนัก)
                                    </label>
                                    <div class="control">
                                        {% if not pa.editable %}
                                        {{ form.percentage(class="input is-success" if pa_item_id else "input", required=True, disabled=True) }}
                                        {% elif pa.editable %}
                                        {{ form.percentage(class="input is-success" if pa_item_id else "input", required=True) }}
                                        {% endif %}
                                        <p class="help has-text-danger" id="percent-warning">สัดส่วนภาระงานรวมเกิน 100%</p>
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="label">
                                        {% if not pa.editable %}
                                            <span class="icon"><i class="fa-solid fa-lock"></i></span>
                                        {% endif %}
                                        ตัวชี้วัดเป้าหมายความสำเร็จของภาระงาน
                                    </label>
                                    <p class="help is-danger">สามารถระบุได้มากกว่า 1 ตัวชี้วัด
                                        โดยคะแนนจะมาจากค่าเฉลี่ยของทุกตัว</p>
                                </div>
                                {% if pa.kpis %}
                                    {% with messages = get_flashed_messages(with_categories=True) %}
                                        {% if messages %}
                                            {% for cat, msg in messages %}
                                                {% if 'ตัวชี้วัด' in msg %}
                                                <p class="notification is-{{ cat }} is-light"><button class="delete"></button>
                                                    <span class="icon">
                                                        <i class="fas fa-info-circle"></i>
                                                    </span>
                                                    {{ msg }}
                                                </p>
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                    {% endwith %}
                                    <table class="table is-fullwidth is-striped">
                                        {% for item_form in form.kpi_items_ %}
                                            <tr>
                                                <td style="width: 40%">
                                                    <div class="field">
                                                        <label class="label">
                                                            {{ loop.index }}) {{ item_form.label }}
                                                        </label>
                                                    </div>
                                                </td>
                                                <td style="width: 45%">
                                                    <div class="select">
                                                        {% if not pa.editable %}
                                                            {{ item_form(disabled=True) }}
                                                            <input name="{{ item_form.id }}" value="{{ item_form.data or '' }}" type="hidden">
                                                        {% elif pa.editable %}
                                                            {{ item_form() }}
                                                        {% endif %}
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="buttons">
                                                        {% if pa.editable %}
                                                            <a href="{{ url_for('pa.edit_kpi', pa_id=pa.id, kpi_id=item_form.obj_id) }}"
                                                               class="button">
                                                                <span class="icon is-small">
                                                                    <i class="fa-solid fa-pencil"></i>
                                                                </span>
                                                            </a>
                                                            <a class="button"
                                                               hx-swap="none"
                                                               hx-confirm="คุณต้องการลบรายการนี้หรือไม่"
                                                               hx-delete="{{ url_for('pa.delete_kpi', kpi_id=item_form.obj_id, pa_id=pa.id) }}">
                                                                <span class="icon is-small">
                                                                    <i class="fa-solid fa-trash-can has-text-danger"></i>
                                                                </span>
                                                            </a>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </table>
                                {% else %}
                                    <p class="notification is-warning is-light"><button class="delete"></button>ท่านยังไม่มีตัวชี้วัดสำหรับประเมินภาระงาน กรุณาเพิ่มตัวชี้วัด</p>
                                {% endif %}
                                <div class="field">
                                    <label class="label">
                                        {% if not pa.editable %}
                                            <span class="icon"><i class="fa-solid fa-lock"></i></span>
                                        {% endif %}
                                        {{ form.report.label }}
                                    </label>
                                    <div class="control">
                                        {% if (pa.approved_at and not pa.submitted) and pa_item_id %}
                                            {{ form.report(class="textarea is-success" if pa_item_id else "textarea", disabled=False) }}
                                        {% else %}
                                            {{ form.report(class="textarea is-success" if pa_item_id else "textarea", disabled=True) }}
                                        {% endif %}
                                    </div>
                                </div>
                                {% if not pa.submitted %}
                                <div class="field is-grouped is-grouped-centered">
                                    <div class="control">
                                        <input type="submit" value="บันทึกภาระงาน" class="button is-success">
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                    <div class="buttons is-centered">
                        {% if not pa.approved_at %}
                            <a class="button is-info"
                               onclick="return confirm('กรุณาบันทึกการแก้ไขก่อนคลิก OK เพื่อดำเนินการเพิ่มตัวชี้วัด หากไม่มีการแก้ไขเพิ่มเติมคลิก OK เพื่อดำเนินการต่อ')"
                               href="{{ url_for('pa.add_kpi', pa_id=pa.id, round_id=pa_round.id) }}">
                                                <span class="icon">
                                                    <i class="fa-solid fa-location-crosshairs"></i>
                                                </span>
                                <span>เพิ่มตัวชี้วัด</span>
                            </a>
                        {% endif %}
                        <a href="{{ url_for('pa.create_request', pa_id=pa.id) }}"
                           class="button is-info is-outlined">
                            <span class="icon">
                                <i class="fa-sharp fa-solid fa-paper-plane"></i>
                            </span>
                            <span>ส่งคำขอ</span>
                        </a>
                        {% if pa.approved_at %}
                        <a href="{{ url_for('pa.create_scoresheet_for_self_evaluation', pa_id=pa.id) }}"
                           class="button is-warning is-outlined">
                            <span class="icon">
                                <i class="fa-solid fa-star"></i>
                            </span>
                            <span>ประเมินตนเอง</span>
                        </a>
                        {% endif %}
                    </div>
                    {% if not pa.editable %}
                    <div class="has-text-centered">
                        <p style="color:red">หากต้องการปรับแก้ไขภาระงาน/ตัวชี้วัด ให้ส่งคำขอแก้ไข</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="columns">
                <div class="column">
                    <h1 class="title">สถานะการประเมินภาระงาน</h1>
                    <table class="table">
                        <thead>
                        <th>สร้างเมื่อ</th>
                        <th>เพื่อ</th>
                        <th>รายละเอียด</th>
                        <th>สถานะ</th>
                        <th>ส่งเมื่อ</th>
                        <th>ตอบกลับเมื่อ</th>
                        <th>comment</th>
                        <th>หัวหน้าส่วนงาน</th>
                        </thead>
                        <tbody>
                        {% for req in pa.requests %}
                            <tr>
                                <td>{{ req.created_at|localdatetime }}</td>
                                <td>{{ req.for_ }}</td>
                                <td>{{ req.detail }}</td>
                                <td>{{ req.status or 'ระหว่างดำเนินการ' }}</td>
                                <td>{{ req.submitted_at|localdatetime }}</td>
                                <td>{{ req.responded_at|localdatetime }}</td>
                                <td>{{ req.supervisor_comment }}</td>
                                <td>{{ req.supervisor.fullname }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    <button onclick="topFunction()" id="myBtn" title="Go to top">
                        <span class="icon"><i class="fas fa-arrow-up"></i></span><span>กลับขึ้นบน</span>
                    </button>
                </div>
            </div>
        </div>
    </section>
{% endblock %}
{% block scripts %}
    {{ super() }}
    <script>
        $(document).ready(function() {
            $('#percent-warning').hide()
            {% if not pa_item_id %}
                $('#percentage').on('keyup', function () {
                    if ($(this).val() > 100 - parseFloat({{ pa.total_percentage|tojson|safe }})) {
                        $(this).addClass('is-danger')
                        $('#percent-warning').show()
                    } else {
                        $(this).removeClass('is-danger')
                        $('#percent-warning').hide()
                    }
                })
            {% else %}
                $('#percentage').on('keyup', function () {
                    if ($(this).val() > 100 + parseFloat({{ form.percentage.data|tojson|safe }}) - parseFloat({{ pa.total_percentage|tojson|safe }})) {
                        $(this).addClass('is-danger')
                        $('#percent-warning').show()
                    } else {
                        $(this).removeClass('is-danger')
                        $('#percent-warning').hide()
                    }
                })
            {% endif %}
        })
    </script>
    <script>
    let mybutton = document.getElementById("myBtn");

    // When the user scrolls down 20px from the top of the document, show the button
    window.onscroll = function() {scrollFunction()};

    function scrollFunction() {
      if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
        mybutton.style.display = "block";
      } else {
        mybutton.style.display = "none";
      }
    }

    // When the user clicks on the button, scroll to the top of the document
    function topFunction() {
      document.body.scrollTop = 0; // For Safari
      document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
    }
    </script>
{% endblock %}