<!doctype html>
<html>
    <head>
        <title>KPI Page</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.6.1/css/bulma.min.css" />
    </head>
    <body>
        <div class="container">
            <h2 class="title">แผนยุทธศาสตร์ฉบับปรับปรุงปี 2560</h2>
        <table class="table is-striped">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Created At</th>
                    <th>Created By</th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody data-bind="foreach: {data: strategies, as: 's'}">
                <tr>
                    <td><span data-bind="text: s.title"</span></td>
                    <td><span data-bind="text: s.description"</span></td>
                    <td><span data-bind="text: s.created_at"</span></td>
                    <td><span data-bind="text: s.created_by"</span></td>
                    <td><a class="icon" data-bind="click: $parent.remove"><i class="fa fa-trash-o"></i></a></td>
                    <td><a class="icon" data-bind="click: function(data,event) { $parent.edit($index, data, event)}"><i class="fa fa-pencil"></i></a></td>
                </tr>
            </tbody>
        </table>
        <div class="field">
            <div class="control">
                <input class="input" type="text" size="40"
                    data-bind="value: title" placeholder="Enter title"/>
            </div>
        </div>
        <div class="field">
            <div class="control">
                <input class="input" type="text" size="40"
                    data-bind="value: desc" placeholder="Enter description"/>
            </div>
        </div>
        <div class="field">
            <div class="control">
                <button class="button" data-bind="click: addNew">Add/Save</button>
            </div>
        </div>
        </div>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.2/knockout-min.js"></script>
        <script type="text/javascript">
            var vm = function() {
                var self = this;
                self.strategies = ko.observableArray();
                self.index = self.strategies.length;
                self.title = ko.observable('');
                self.desc = ko.observable('');
                self.addNew = function() {
                    if (self.index === self.strategies.length) {
                        self.strategies.push({
                            'title' : self.title(),
                            'description': self.desc(),
                            'created_at': '2017/12/31',
                            'created_by': 'username'
                        });
                    } else {
                        var oldStrategy = self.strategies()[self.index];
                        var newStratrgy = {
                            'title' : self.title(),
                            'description': self.desc(),
                            'created_at': '2017/12/31',
                            'created_by': 'username'
                        };
                        self.strategies.replace(oldStrategy, newStratrgy);
                    }
                    self.title('');
                    self.desc('');
                    self.index = self.strategies.length;
                };
                self.edit = function(index, strategy) {
                    self.title(strategy.title);
                    self.desc(strategy.description);
                    self.index = index();
                };
                self.remove = function(strategy) {
                    self.strategies.remove(strategy);
                };
            }
            var viewModel = new vm();
            ko.applyBindings(viewModel);
            $.get('/kpi/list/', function(data) {
                $.each(data, function(idx, dat) {
                    viewModel.strategies.push(dat);
                    viewModel.index = viewModel.strategies.length;
                });
            });
        </script>
    </body>
</html>